services:
  wp-proxy:
    default: true
    image: q0rban/wp-proxy
    depends: php
    aliases:
      - '2020'
      - '2021'
      - '2022'
      - '2023'
      - '2024'
  php:
    image: tugboatqa/php:8.2-apache
    checkout: true
    depends: mysql
    commands:
      init:
        - apt-get update
        - apt-get install -y rsync libzip-dev libmagickwand-dev

        - a2enmod rewrite headers

        - docker-php-ext-install mysqli exif zip opcache

        - mkdir -p "${TUGBOAT_ROOT}/build"
        - ln -snf "${TUGBOAT_ROOT}/build" "${DOCROOT}"
        - ln -snf "${TUGBOAT_ROOT}/.tugboat/.htaccess" "${DOCROOT}/.htaccess"

      update:
        # Install the latest wp-cli
        - curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        - chmod +x wp-cli.phar
        - mv wp-cli.phar /usr/local/bin/wp
        # Install NodeJS version from nvmrc.
        - curl -fsSL https://deb.nodesource.com/setup_$(cat .nvmrc).x | bash -
        - apt-get install nodejs
        # Run npm install
        - npm install
        - npm run build

        # Generate wp-config for Tugboat, with multisite.
        - rm -f $DOCROOT/wp-config.php
        - wp --allow-root --path=$DOCROOT config create
            --dbhost=mysql
            --dbname=tugboat
            --dbuser=tugboat
            --dbpass=tugboat
        - wp --allow-root --path=$DOCROOT core multisite-install
            --subdomains
            --url=localhost
            --title="WordPress Core"
            --admin_user=admin
            --admin_password=admin
            --admin_email=admin@example.com

        - wp --allow-root --path=$DOCROOT config set ADMIN_COOKIE_PATH "/"
        - wp --allow-root --path=$DOCROOT config set COOKIE_DOMAIN ""
        - wp --allow-root --path=$DOCROOT config set COOKIEPATH ""
        - wp --allow-root --path=$DOCROOT config set SITECOOKIEPATH ""
        - wp --allow-root --path=$DOCROOT config set --raw DOMAIN_CURRENT_SITE "htmlentities( \$_SERVER['HTTP_HOST'] ?? 'localhost' )"

        - wp --allow-root --path=$DOCROOT plugin install wordpress-importer --activate
        - curl -O https://raw.githubusercontent.com/WPTT/theme-test-data/master/theme-preview.xml
        - wp --allow-root --path=$DOCROOT --authors=create --url=localhost import theme-preview.xml

        - wp --path=$DOCROOT --allow-root site create --slug=2020 --title="Twenty Twenty"
        - wp --allow-root --path=$DOCROOT --url=2020.localhost plugin install wordpress-importer --activate
        - wp --allow-root --path=$DOCROOT --url=2020.localhost --authors=create import theme-preview.xml
        - wp --allow-root --path=$DOCROOT --url=2020.localhost theme install twentytwenty --activate

        - wp --path=$DOCROOT --allow-root site create --slug=2021 --title="Twenty Twenty-One"
        - wp --allow-root --path=$DOCROOT --url=2021.localhost plugin install wordpress-importer --activate
        - wp --allow-root --path=$DOCROOT --url=2021.localhost --authors=create import theme-preview.xml
        - wp --allow-root --path=$DOCROOT --url=2021.localhost theme install twentytwentyone --activate

        - wp --path=$DOCROOT --allow-root site create --slug=2022 --title="Twenty Twenty-Two"
        - wp --allow-root --path=$DOCROOT --url=2022.localhost plugin install wordpress-importer --activate
        - wp --allow-root --path=$DOCROOT --url=2022.localhost --authors=create import theme-preview.xml
        - wp --allow-root --path=$DOCROOT --url=2022.localhost theme install twentytwentytwo --activate

        - wp --path=$DOCROOT --allow-root site create --slug=2023 --title="Twenty Twenty-Three"
        - wp --allow-root --path=$DOCROOT --url=2023.localhost plugin install wordpress-importer --activate
        - wp --allow-root --path=$DOCROOT --url=2023.localhost --authors=create import theme-preview.xml
        - wp --allow-root --path=$DOCROOT --url=2023.localhost theme install twentytwentythree --activate

        - wp --path=$DOCROOT --allow-root site create --slug=2024 --title="Twenty Twenty-Four"
        - wp --allow-root --path=$DOCROOT --url=2024.localhost plugin install wordpress-importer --activate
        - wp --allow-root --path=$DOCROOT --url=2024.localhost --authors=create import theme-preview.xml
        - wp --allow-root --path=$DOCROOT --url=2024.localhost theme install twentytwentyfour --activate

        - apt-get clean
        - rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

      build:
        - npm install
        - npm run build

  mysql:
    image: tugboatqa/mysql:5
    commands:
      update:
        - mysql -e "DROP DATABASE IF EXISTS tugboat; CREATE DATABASE tugboat;"

